从零开始实现一个“数据库”

# MiniDB 需求分析

需求目标：单机关系型数据库，满足acid



## 数据库的基本构成

通过分析MySQL、SQLite的整体架构，总结一个数据库必要的基本构成

#### 1. MySQL 简化的逻辑架构图：

![](https://rayalioss.oss-cn-shanghai.aliyuncs.com/img/v2-e22b20b8a3306531796ce0fa3cb31122_1440w.jpg)



mysql架构可分为大概的4层，分别是：

**1.客户端**：各种语言都提供了连接mysql数据库的方法

**2.server层**：包括连接器、查询缓存、分析器、优化器、执行器等

**3.存储引擎层**：负责数据的存储和提取，是真正与底层物理文件打交道的组件。

**4.物理文件层**：存储数据库真正的表数据、日志等



#### 2. SQLite 基本构成

SQLiite 由被组织在3个子系统中的8个独立的模块组成, 这些模块又被分割为两个部分: 前端解析系统和后端引擎

![](https://rayalioss.oss-cn-shanghai.aliyuncs.com/img/2.jpg)



前端解析系统，即编译器/ SQL解析器 部分，包括三个模块：

1. 分词器：词法分析器，把原有字符串分割成一个个标识符（token），将SQL语句进行分词
2. 分析器：语法分析器+语义分析+代价优化，将词法分析器的输出作为它的输入，结合语义(利用元数据判断，比如表是否存在)，生成一个语法树，并最终转换化为执行计划树，这个过程中包含了通过优化器选择最佳路径。使用Lemon LALR(1)分析程序生成器来产生，Lemon做的工作与YACC/BISON相同；
3. 代码生成器：将执行计划树生成虚拟机指令集，这个是sqlite比较独特的地方，主要为虚拟机做准备

后端引擎，真正的数据库处理工作，由四个模块构成：

1. 虚拟机：通过执行代码生成器产生的指令集，来执行SQL语句满足用户的需求。通过操作数据库文件中的记录，来查询或修改数据。
2. B/B+ 树：将用户的记录通过B树结构来管理，每个用户表通过一个B+树管理，每个索引通过一个B树管理
3. 页处理器Pager：在tree模块看来，所有的B树的节点都是在内存中的，tree模块不直接与数据库文件打交道。Pager模块负责直接与数据库文件交互
4. 操作系统接口：针对不同的操作系统，提供统一的操作文件接口，使得上层的Pager模块并不关心底层的硬件和操作系统，只需要调用统一的接口就能达到读写文件的目的



## 初步需求确定

“虽然各个数据库的模块划分可能千差万别，但基本功能是一致的。为了解析SQL，一定有词法+语法分析+语义分析；为了能执行SQL语句，一定需要先生成执行计划，并通过优化器选择最优的执行计划；为了实现事务的ACID特性，一定有事务管理模块，并发控制模块和故障恢复模块等”

通过对上述MySQL的结构进行更大程度的简化，

1. 可直接在数据库服务器本地通过命令行与Server交互，暂不关注客户端的实现
2. 可仅满足能够执行简单的sql 语句，生成执行计划，暂不需要优化，暂不使用缓存。只需实现分析器，执行器
3. 需实现存储引擎将数据持久化，使用B/B+ 树作为索引结构
4. 持久化数据保存到文件中，暂不实现记录日志



MySQL 参考：

- [MySQL架构图](https://zhuanlan.zhihu.com/p/338685772)

SQLite 参考：

- [SQlite源码分析](https://huili.github.io/)——体系结构： https://huili.github.io/sqlite/system.html

- [SQLite学习笔记(八)&&sqlite实现架构](https://www.cnblogs.com/cchust/p/4964150.html) https://www.cnblogs.com/cchust/p/4964150.html

